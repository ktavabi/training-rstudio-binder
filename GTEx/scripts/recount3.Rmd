---
title: "recount3"
output: md_document
params: 
  myproject: "HEART"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r recount3}
library(tidyverse)
library(recount3)

# get GTEx heart data
human_projects <- available_projects(organism = "human")

# enter yes

head(human_projects)
tail(human_projects)

gtex <- subset(human_projects,
                     project == params$myproject  & 
                       file_source == "gtex" & 
                       project_type == "data_sources" )

head(gtex)

rse_gtex <- create_rse(gtex)
rse_gtex

# format data for DESEq2
countData <- assays(rse_gtex)$raw_counts %>% as.data.frame()
colData <- colData(rse_gtex) %>% as.data.frame()

# check that rows and samples match
head(rownames(colData) == colnames(countData))

# variables
dim(colData)
dim(countData)


colData <-  colData %>%
  filter(gtex.run_acc != "NA",
         gtex.smnabtcht != "RNA isolation_PAXgene Tissue miRNA") %>%
  dplyr::select(external_id, study, gtex.run_acc, 
                gtex.age, gtex.smtsd)
head(colData)

# get countdata for this subset of colData

## colData and countData must contain the exact same samples. 
savecols <- as.character(rownames(colData)) #select the rowsname 
savecols <- as.vector(savecols) # make it a vector
countData <- countData %>% dplyr::select(one_of(savecols)) # select just the columns 
 

# variables
dim(colData)
dim(countData)

# check that rows and samples match
head(rownames(colData) == colnames(countData))

names(countData) <- gsub(x = names(countData), pattern = "\\-", replacement = "_")
rownames(colData) <- gsub(x = rownames(colData) , pattern = "\\-", replacement = "_")


# check that rows and samples match
head(rownames(colData) == colnames(countData))

head(colData)[1:5]
head(countData)[1:5]

write.csv(countData, file = paste("../data/countData", params$myproject, "csv", sep = "."),
          row.names = T)
write.csv(colData, file = paste("../data/colData", params$myproject, "csv", sep = "."),
          row.names = T)

```



